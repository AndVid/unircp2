---
# full list of commands available here: https://github.com/jadebustos/devopslabs/blob/master/labs-k8s/00-00-instalando-kubernetes.md
# common configurations to both machines - second part
- name: modprobe
  modprobe:
    name: br_netfilter
    state: present
  become: yes
- name: set transparent masquerading
  firewalld: 
    masquerade: yes 
    permanent: true 
    zone: public
    state: enabled
- name: reboot firewall
  command: firewall-cmd --reload
- name: allow traffic management
  copy: 
   src: k8s.conf
   dest: "/etc/sysctl.d/k8s.conf"
- name: applying changes
  command: sysctl --system
#- name: Install cri-o
#  dnf:
#   name: cri-o
#   state: latest
# - name: add Kubernetes YUM repository
#   yum_repository:
#     name: Kubernetes
#     description: Kubernetes YUM repository
#     baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
#     gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
#     gpgcheck: yes
#     exclude: kubelet kubeadm kubectl
#     enabled: yes
# - name: copying file kubernetes.repo
#   become: yes
#   copy:
#     src: kubernetes.repo
#     dest: /etc/yum.repos.d/kubernetes.repo
#     owner: root
#     group: root
#     mode: 0644
# # - name: update
# #   command: dnf update 
# - name: instalando k8s
#   command: dnf install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
# - name: Habilitar e iniciamos el servicio de Kubernetes
#   systemd:
#     name: kubelet
#     state: started
#     enabled: yes
#     masked: no
# - name: Initiating and enabling kubelet service permanently  
#   service:
#     name: "kubelet"
#     state: started
#     enabled: yes
- name: Configuramos el repositorio de Kubernetes
  yum_repository:
    name: Kubernetes
    description: Repositorio oficial de Kubernetes
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    enabled: yes
    gpgcheck: yes
    repo_gpgcheck: yes
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    exclude: kubelet kubeadm kubectl
  become: yes

- name: Instalamos Kubernetes
  dnf:
    name: "{{ item }}"
    state: present
    disable_excludes: Kubernetes
  become: yes
  with_items: 
    - kubelet
    - kubeadm 
    - kubectl

- name: Habilitar e iniciamos el servicio de Kubernetes
  systemd:
    name: kubelet
    state: started
    enabled: yes
    masked: no
  become: yes